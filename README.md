# FitAI Telegram Bot with GigaChat

**FitAI** — это асинхронный Telegram-бот, который помогает пользователям достичь спортивных целей.  
Он умеет:
- Принимать и хранить **регистрационные данные** (имя, возраст, вес, рост и т.д.)  
- Генерировать **рацион питания** и **программу тренировок** на базе [GigaChat](https://github.com/langchain-ai/langchain) (через LangChain Community)  
- Сохранять и просматривать **историю диалогов** в базе данных (PostgreSQL через SQLAlchemy)  
- **Планировать уведомления** на будущее время с помощью [APScheduler](https://apscheduler.readthedocs.io/en/stable/), а также отправлять пользователю напоминания через бот.  
- Отслеживать **неактивность** пользователя (7 дней) и автоматически мотивировать его вновь заняться спортом.

## Структура проекта

```
.
├── config.py             # Параметры Telegram Bot и PostgreSQL
├── db.py                 # SQLAlchemy-модели (User, MessageLog, Notification)
├── fit_ai.py             # Основной класс FitAI (работа с GigaChat и function calling)
├── function_calling/     # Вызов "функций" (create_notification, update, delete...)
│   ├── __init__.py
│   └── manager.py
├── handlers/             # Роутеры Aiogram (регистрация, меню)
│   ├── __init__.py
│   ├── menu.py
│   └── registration.py
├── init_bot.py           # Инициализация Aiogram Bot & Dispatcher
├── main.py               # Точка входа (старт бота, schedule_existing_notifications)
├── notifications/        # Логика работы с APScheduler и уведомлениями
│   ├── __init__.py
│   └── manager.py
├── blockscheme.png       # Блок-схема работы бота
├── README.md
└── requirements.txt
```

## Подготовка и запуск

1. **Установите PostgreSQL** и создайте базу/пользователя:
   ```sql
   CREATE USER bot_user WITH PASSWORD 'bot_pass';
   CREATE DATABASE bot_db OWNER bot_user;
   ```
   Убедитесь, что в `config.py` указаны верные настройки:
   ```python
   POSTGRES_DB = "bot_db"
   POSTGRES_USER = "bot_user"
   POSTGRES_PASSWORD = "bot_pass"
   POSTGRES_HOST = "localhost"
   POSTGRES_PORT = 5432
   ```

2. Укажите ваш **Telegram Bot Token** в `config.py`:
   ```python
   TELEGRAM_BOT_TOKEN = "1234567:ABCDEFG..."
   ```
3. **Установите зависимости** (например, через pip):
   ```bash
   pip install -r requirements.txt
   ```
4. **Запустите**:
   ```bash
   python main.py
   ```
5. Найдите бота в Telegram и нажмите **Start**.

## Проверка уведомлений

1. После регистрации попробуйте вызвать функцию GigaChat либо вручную: `/chat Хочу создать уведомление на 2025-01-18T14:00:00+03:00` (пример).  
2. Модель может ответить JSON, например:

   ```json
   {
     "name": "create_notification",
     "parameters": {
       "user_id": "1",
       "message": "Пора на тренировку!",
       "time": "2025-01-18T14:00:00+03:00"
     }
   }
   ```
3. После этого бот подтвердит, что функция выполнена. Зайдите в базу (таблица `notifications`) и убедитесь, что запись создалась.  
4. Дождитесь указанного времени — бот отправит уведомление в личку.  


## Блок-схема работы

Ниже приведена примерная блок-схема с основными этапами работы бота — от **регистрации** пользователя до отправки уведомлений (включая неактуальные данные и ошибки).

![blockscheme](/blockscheme.png)
1. **Регистрация**: бот спрашивает имя, возраст, пол и т.д. При некорректном вводе — повторяет запрос. При успехе — сохраняет в базу.  
2. **Меню**: пользователь вызывает команды `/menu`, `/meal_plan`, `/workout_plan`, `/chat ...`.  
3. **Диалог с моделью**: используется класс `FitAI`, который загружает историю сообщений в из `PostgreSQL`. Если в ответе GigaChat есть JSON-функция (например, `{"name":"create_notification", "parameters":{...}}`), вызывается соответствующая функция из пакета `function_calling`.  
4. **Уведомления**: при создании уведомления оно сохраняется в таблицу `notifications` и регистрируется в планировщике Apscheduler. Когда наступает `time_utc`, Apscheduler вызывает `_notify_user(...)`.  
5. **Неактивность**: каждый раз при сообщении пользователя таймер «7 дней неактивности» перезапускается. По истечении 7 дней вызывается `handle_inactivity(...)`, которая генерирует для пользователя новую мотивацию.  

Так бот обрабатывает все запросы и уведомления, учитывая локальное время пользователя (перевод в UTC при сохранении).  

---

## Команда

> Работу выполнили студенты Высшей Школы Экономики Факультета "Московский институт Электроники и Математики им. А.Н. Тихонова",
> по специальности "Информатика и вычислительная техника"
> Группы Бакалавриата Информатика и вычислительная техника БИВ236:
> Гибельгаус Кирилл Сергеевич, Сенчуков Егор Дмитриевич год поступления 2023 год. год выпуска 2027 год. Работа была выполнена по дисциплине Major Научно-исследовательский семинар "Искусственный интеллект в инженерном образовании" (2024/2025 модули: 2,3) Преподаватель: Доцент Варнавский Александр Николаевич.

---

### Вклад участников

1. **Гибельгаус Кирилл Сергеевич**:
   - Интеграция LLM (large language model) и function calling.
   - Разработка системы управления взаимодействием с LLM.
   - Написание интерфейсов для работы с внешними API моделей.
   - **Документирование**: Написание README.md с подробным описанием проекта и инструкциями по его установке.
   - **Архитектура и конфигурация**: Разработка файла `config.py` с гибкими настройками проекта, настройка окружения через `requirements.txt`.

2. **Сенчуков Егор Дмитриевич**:
   - Реализация уведомлений через различных ботов и системы оповещений.
   - Настройка SQL-базы данных для корректного взаимодействия с Apscheduler.
   - Оптимизация работы планировщика задач.
   - **Тестирование и отладка**: Устранение ошибок и проверка корректности работы всех модулей проекта.
   - **Интерфейс меню**: Создание и настройка пользовательского меню в `menu.py`.
